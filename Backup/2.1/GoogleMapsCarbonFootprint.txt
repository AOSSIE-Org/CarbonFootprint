/*
 * Copyright (c) 2011 Bruno Woltzenlogel Paleo. All rights reserved.
 */


alert("hello")

var carbonEmission = 180 // in grams of CO2 per km
chrome.extension.sendRequest({carbonEmission : "Request Carbon Efficiency..." }, function(response) {
  carbonEmission = response.carbonEmission;
  setInterval('checksDOM()',500)
});


function checksDOM() {
  var route = document.getElementById("altroute_0")
  var carbon = document.getElementById("carbon_0")
  if ((route != null) && (carbon == null)) {
    while (route.nodeName == "LI") {
      var kmDiv = route.getElementsByTagName("DIV")[4]
      addCarbonFootprint(kmDiv)
      route = route.nextSibling      
    }
  }
};

function addCarbonFootprint(kmDiv) {
  var content = kmDiv.innerHTML
  var distance = content.split(/ /)[0].replace(/[^\d]/g, '') // Removes non-digits from content. 
  alert("hi " + distance)
  if (content.match(/\bm\b/)  || content.match(/\b?\b/)) { // Distance given in meters.
      alert("hi2"); distance = distance/1000; 
  }
//  else if (content.match(/\bmi\b/) || content.match(/\bMeile\/n\b/) || content.match(/\b???.\b/)) { // Distance given in miles.
//      alert("hi3"); distance = distance * 1.609344; 
//  } 
  alert("hi4 " + distance);
  var carbonFootprint = computeCarbonFootprint(distance)
  alert("hi5 " + carbonFootprint);
  var carbonUnit = " g CO<sub>2</sub>"
  alert("hi6");
  if (carbonFootprint > 1000) {
    alert("hi7");
    carbonFootprint = carbonFootprint/1000
    if (carbonFootprint > 10) {carbonFootprint = Math.round(carbonFootprint)}
    carbonUnit = " kg CO<sub>2</sub>"
  }
  var spaces = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
  kmDiv.innerHTML = kmDiv.innerHTML + "<span class='carbon' id='carbon_0'>"+ spaces + carbonFootprint + carbonUnit + " <a class='offset-link' href='http://sites.google.com/site/mapsfootprint/offset-your-carbon-emissions' target='_blank'>offset now!</a> </span>"  
}

function computeCarbonFootprint(distance) {
  return distance * carbonEmission
}